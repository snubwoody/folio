name: CI/CD
env:
  DATABASE_URL: sqlite://data.db
  CARGO_TERM_COLOR: always
on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]
concurrency:
  group: ci-${{github.ref}}-${{github.workflow}}
  cancel-in-progress: true
jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false
      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: Run pnpm lint
        run: pnpm -r lint
  clippy:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/cache@v4
        with:
          key: rust-cache-${{runner.os}}-${{hashFiles('**/Cargo.lock')}}
          restore-keys: |
            rust-cache-${{runner.os}}-
            rust-cache-
          path: |
            packages/desktop/src-tauri/target/
            ~/.cargo
      - uses: actions/cache@v4
        id: cache-sqlx
        with:
          key: cargo-sqlx-cache-${{runner.os}} # Permanently cache sqlx
          path: ~/.cargo/bin
      - name: Install sqlx-cli
        if: ${{steps.cache-sqlx.outputs.cache-hit != 'true'}}
        run: cargo install sqlx-cli
      - name: Setup database
        run: |
          cd packages/desktop/src-tauri
          cargo sqlx database create
          cargo sqlx migrate run
      - name: Run cargo clippy
        run: |
          cd packages/desktop/src-tauri
          cargo clippy --all-features --all-targets -- -D warnings
  format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check formatting
        run: |
          cd packages/desktop/src-tauri
          cargo fmt --check
  test-frontend:
    permissions:
      pull-requests: write
      checks: write
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false
      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: Install playwright browsers
        run: pnpm playwright install --with-deps
      - name: Run tests
        run: pnpm -r test:headless
  build-frontend:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false
      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: Build frontend
        run: pnpm -r build
  test:
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
    runs-on: ${{matrix.os}}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/cache@v4
        with:
          key: rust-cache-${{runner.os}}-${{hashFiles('**/Cargo.lock')}}
          restore-keys: |
            rust-cache-${{runner.os}}-
            rust-cache-
          path: |
            packages/desktop/src-tauri/target/
            ~/.cargo
      - uses: actions/cache@v4
        id: cache-sqlx
        with:
          key: cargo-sqlx-cache-${{runner.os}} # Permanenly cache sqlx
          path: ~/.cargo/bin
      - uses: taiki-e/install-action@nextest
      - name: Install sqlx-cli
        if: ${{steps.cache-sqlx.outputs.cache-hit != 'true'}}
        run: cargo install sqlx-cli
      - name: Setup database
        run: |
          cd packages/desktop/src-tauri
          cargo sqlx database create
          cargo sqlx migrate run
      - name: Install system dependencies
        if: ${{runner.os == 'Linux'}}
        run: |
          sudo apt update
          sudo apt install libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libxdo-dev \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev
      - name: Run tests
        run: |
          cd packages/desktop/src-tauri
          cargo nextest run --locked
  build-test:
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest,macos-latest,ubuntu-latest]
    runs-on: ${{matrix.os}}
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false
      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm
      - uses: actions/cache@v4
        name: Cache rust
        with:
          key: rust-cache-${{runner.os}}-${{hashFiles('**/Cargo.lock')}}
          restore-keys: |
            rust-cache-${{runner.os}}-
            rust-cache-
          path: |
            packages/desktop/src-tauri/target/
            ~/.cargo
      - uses: actions/cache@v4
        id: cache-sqlx
        with:
          key: cargo-sqlx-cache-${{runner.os}} # Permanenly cache sqlx
          path: ~/.cargo/bin
      - uses: taiki-e/install-action@nextest
      - name: Install sqlx-cli
        if: ${{steps.cache-sqlx.outputs.cache-hit != 'true'}}
        run: cargo install sqlx-cli
      - name: Setup database
        run: |
          cd packages/desktop/src-tauri
          cargo sqlx database create
          cargo sqlx migrate run
      - name: Install system dependencies
        if: ${{runner.os == 'Linux'}}
        run: |
          sudo apt update
          sudo apt install libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libxdo-dev \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev
      - run: pnpm install
      - uses: cargo-bins/cargo-binstall@main
      - run: cargo 
      - name: Build
        run: pnpm -F desktop tauri build
      - name: Build msix
        if: ${{runner.os == 'Windows'}}
        run: |
          cd packages/desktop/src-tauri
          cp target/release/folio.exe target/release/folio_lib.dll msix 
          makeappx /d msix /p target/release/bundle/folio_x64.msix
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: folio-upload-${{ matrix.os }}
          path: |
            src-tauri/target/release/bundle/**/*.deb
            src-tauri/target/release/bundle/**/*.rpm
            src-tauri/target/release/bundle/**/*.AppImage
            src-tauri/target/release/bundle/**/*.msi
            src-tauri/target/release/bundle/**/*.msix
            src-tauri/target/release/bundle/**/*.exe
            src-tauri/target/release/bundle/**/*.dmg
  pass:
    needs:
      - format
      - lint
      - clippy
      - test
      - test-frontend
      - build-frontend
    runs-on: ubuntu-latest
    steps:
      - name: Complete
        run: echo All good!
